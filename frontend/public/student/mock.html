<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Placement Cell | Smart Interview Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --dark-blue: #0a3d91; --royal-blue: #0a66c2; --orange: #f2ad58; }
        body { background-color: #f4f6fa; font-family: 'Segoe UI', sans-serif; }
        .glass-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--royal-blue); color: white; transition: 0.3s; }
        .btn-primary:hover { background: var(--dark-blue); }
        .resource-pill { background: #eef2f7; padding: 10px 15px; border-radius: 12px; font-size: 0.85rem; border: 1px solid #dce4ee; }
        video { transform: scaleX(-1); border-radius: 15px; background: #000; border: 3px solid #fff; }
        .recording-pulse { animation: pulse 1.5s infinite; color: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef } = React;

        const MASTER_DB = {
            aptitude: [
                { q: "A shopkeeper sells an item at 20% profit. If the cost price is $500, find the selling price.", keywords: ["600", "price"], hint: "SP = CP + (Profit% of CP)" },
                { q: "What is the next number in the series: 5, 10, 20, 40, ...?", keywords: ["80", "eighty"], hint: "Each number is multiplied by 2." }
            ],
            general: [
                { q: "What are your strengths and weaknesses?", keywords: ["hardworking", "punctual", "communication", "learning"], hint: "Be honest but focus on how you improve weaknesses." }
            ],
            cs: [
                { q: "What is the difference between TCP and UDP?", keywords: ["connection", "reliable", "handshake", "fast", "packet"], hint: "TCP is connection-oriented, UDP is connectionless." },
                { q: "Define Primary Key and Foreign Key in SQL.", keywords: ["unique", "identifier", "reference", "relation"], hint: "Primary key identifies a record; Foreign key links tables." }
            ],
            mech: [
                { q: "What is the function of a Flywheel?", keywords: ["energy", "fluctuation", "storage", "speed"], hint: "It stores energy during the power stroke." }
            ],
            civil: [
                { q: "What is the use of a Theodolite?", keywords: ["angle", "horizontal", "vertical", "measurement"], hint: "Used for measuring horizontal and vertical angles." }
            ]
        };

        function InterviewPortal() {
            const [step, setStep] = useState('setup');
            const [branch, setBranch] = useState('cs');
            const [sessionQs, setSessionQs] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answer, setAnswer] = useState("");
            const [scores, setScores] = useState([]);
            const [isListening, setIsListening] = useState(false);
            
            const videoRef = useRef(null);
            const chartRef = useRef(null);
            const recognitionRef = useRef(null);

            // Initialize Speech Recognition
            useEffect(() => {
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';

                    recognition.onresult = (event) => {
                        let transcript = "";
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            transcript += event.results[i][0].transcript;
                        }
                        setAnswer(transcript);
                    };
                    recognitionRef.current = recognition;
                }
            }, []);

            const startSession = async () => {
                const mix = [
                    ...MASTER_DB.aptitude.sort(() => 0.5 - Math.random()).slice(0, 2),
                    ...MASTER_DB.general.slice(0, 1),
                    ...MASTER_DB[branch].sort(() => 0.5 - Math.random()).slice(0, 2)
                ];
                setSessionQs(mix);
                setStep('active');
                
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                if (videoRef.current) videoRef.current.srcObject = stream;
                
                if (recognitionRef.current) {
                    recognitionRef.current.start();
                    setIsListening(true);
                }
            };

            const calculateGrade = (avg) => {
                if (avg >= 85) return "O (Outstanding)";
                if (avg >= 70) return "A (Excellent)";
                if (avg >= 50) return "B (Average)";
                return "C (Needs Improvement)";
            };

            const nextQ = async () => {
                let currentMatch = 0;
                sessionQs[currentIdx].keywords.forEach(k => { if(answer.toLowerCase().includes(k)) currentMatch++; });
                const score = Math.round((currentMatch / sessionQs[currentIdx].keywords.length) * 100);
                const updatedScores = [...scores, score];
                setScores(updatedScores);
                setAnswer("");

                if (currentIdx < sessionQs.length - 1) {
                    setCurrentIdx(currentIdx + 1);
                } else {
                    if (recognitionRef.current) recognitionRef.current.stop();
                    setStep('result');
                    
                    const avg = Math.round(updatedScores.reduce((a,b) => a+b, 0) / updatedScores.length);
                    saveToHistory(avg);

                    const userId = localStorage.getItem("userId");
                    if(userId) {
                        try { await fetch(`/api/auth/user/${userId}/increment-interview`, { method: 'POST' }); } 
                        catch (e) { console.log("DB Update Failed"); }
                    }
                    setTimeout(() => renderChart(updatedScores), 300);
                }
            };

            const saveToHistory = (avg) => {
                const history = JSON.parse(localStorage.getItem("interviewHistory") || "[]");
                const newEntry = {
                    date: new Date().toLocaleDateString(),
                    branch: branch.toUpperCase(),
                    score: avg,
                    grade: calculateGrade(avg)
                };
                history.unshift(newEntry);
                localStorage.setItem("interviewHistory", JSON.stringify(history.slice(0, 5)));
            };

            const renderChart = (data) => {
                new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: ['Apt 1', 'Apt 2', 'HR', 'Tech 1', 'Tech 2'],
                        datasets: [{ label: 'Score %', data: data, backgroundColor: '#0a66c2', borderRadius: 5 }]
                    },
                    options: { scales: { y: { beginAtZero: true, max: 100 } } }
                });
            };

            if (step === 'setup') {
                return React.createElement("div", { className: "max-w-4xl mx-auto mt-10 p-4" },
                    React.createElement("div", { className: "glass-card p-10 mb-6" },
                        React.createElement("h2", { className: "text-3xl font-bold mb-4 text-blue-900" }, "AI Mock Interview Portal"),
                        React.createElement("p", { className: "mb-6 text-gray-600" }, "Tailored questions for your branch with real-time speech analysis."),
                        React.createElement("select", { className: "w-full p-4 border rounded-xl mb-8 font-bold text-blue-800", onChange: (e) => setBranch(e.target.value) },
                            React.createElement("option", { value: "cs" }, "Computer Science / IT"),
                            React.createElement("option", { value: "mech" }, "Mechanical Engineering"),
                            React.createElement("option", { value: "civil" }, "Civil Engineering")
                        ),
                        React.createElement("button", { onClick: startSession, className: "btn-primary w-full py-4 rounded-xl font-bold text-lg shadow-lg" }, "LAUNCH INTERVIEW")
                    ),
                    React.createElement("div", { className: "glass-card p-8" },
                        React.createElement("h3", { className: "font-bold text-lg mb-4 text-blue-900" }, "ðŸ“š Preparation Resources"),
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-3 gap-4" },
                            React.createElement("div", { className: "resource-pill" }, React.createElement("i", {className: "fa-solid fa-book mr-2"}), "Aptitude: RS Aggarwal"),
                            React.createElement("div", { className: "resource-pill" }, React.createElement("i", {className: "fa-solid fa-comments mr-2"}), "HR: STAR Method Guide"),
                            React.createElement("div", { className: "resource-pill" }, React.createElement("i", {className: "fa-solid fa-code mr-2"}), "Tech: InterviewBit / GFG")
                        )
                    )
                );
            }

            if (step === 'active') {
                return React.createElement("div", { className: "max-w-6xl mx-auto mt-10 grid grid-cols-1 md:grid-cols-2 gap-8 p-4" },
                    React.createElement("div", null,
                        React.createElement("video", { ref: videoRef, autoPlay: true, muted: true, className: "w-full aspect-video shadow-2xl" }),
                        React.createElement("div", { className: "mt-4 p-4 glass-card flex items-center justify-between" }, 
                            React.createElement("div", null, 
                                React.createElement("p", {className:"text-sm font-bold"}, "AI Facial Analysis: Active"),
                                React.createElement("p", {className:"text-xs text-gray-400 font-mono"}, "Status: Tracking confidence levels...")
                            ),
                            isListening && React.createElement("i", {className: "fa-solid fa-microphone recording-pulse text-xl"})
                        )
                    ),
                    React.createElement("div", { className: "glass-card p-8 flex flex-col h-[520px]" },
                        React.createElement("div", {className: "flex justify-between items-center mb-4"},
                            React.createElement("span", {className:"text-orange-600 font-black text-xs tracking-widest"}, "ROUND " + (currentIdx + 1)),
                            React.createElement("span", {className:"text-gray-400 text-xs"}, "Speak clearly into your mic")
                        ),
                        React.createElement("h3", { className: "text-xl font-bold mb-6 text-blue-900 leading-tight" }, sessionQs[currentIdx].q),
                        React.createElement("textarea", { 
                            className: "flex-grow p-5 bg-gray-50 border-2 border-blue-100 rounded-2xl resize-none text-lg focus:border-blue-400 outline-none transition-all",
                            placeholder: "Your spoken words will appear here automatically...",
                            value: answer,
                            onChange: (e) => setAnswer(e.target.value)
                        }),
                        React.createElement("button", { onClick: nextQ, className: "btn-primary py-4 rounded-xl mt-6 font-bold shadow-xl flex items-center justify-center gap-2" }, 
                            currentIdx === 4 ? "FINISH INTERVIEW" : "SUBMIT RESPONSE",
                            React.createElement("i", {className:"fa-solid fa-arrow-right"})
                        )
                    )
                );
            }

            if (step === 'result') {
                const avg = Math.round(scores.reduce((a,b) => a+b, 0) / scores.length);
                const history = JSON.parse(localStorage.getItem("interviewHistory") || "[]");

                return React.createElement("div", { className: "max-w-5xl mx-auto mt-10 p-4" },
                    React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8" },
                        React.createElement("div", { className: "glass-card p-8 text-center border-b-4 border-blue-600 col-span-1" },
                            React.createElement("p", {className:"text-gray-500 uppercase text-xs font-bold mb-2"}, "Session Grade"),
                            React.createElement("h1", {className:"text-3xl font-black text-blue-700"}, calculateGrade(avg))
                        ),
                        React.createElement("div", { className: "glass-card p-8 text-center border-b-4 border-orange-500 col-span-1" },
                            React.createElement("p", {className:"text-gray-500 uppercase text-xs font-bold mb-2"}, "Average Score"),
                            React.createElement("h1", {className:"text-5xl font-black text-orange-600"}, avg + "%")
                        ),
                        React.createElement("div", { className: "glass-card p-8 col-span-1 flex flex-col justify-center" },
                            React.createElement("p", {className:"text-gray-500 uppercase text-xs font-bold mb-2"}, "Previous 3 Sessions"),
                            history.slice(1,4).map((h, i) => 
                                React.createElement("div", {key:i, className:"flex justify-between text-sm py-1 border-b last:border-0"},
                                    React.createElement("span", null, h.date),
                                    React.createElement("span", {className:"font-bold"}, h.score + "%")
                                )
                            )
                        )
                    ),
                    React.createElement("div", { className: "grid grid-cols-1 lg:grid-cols-2 gap-8" },
                        React.createElement("div", { className: "glass-card p-6" }, 
                            React.createElement("h4", {className:"font-bold mb-4 text-blue-900"}, "Detailed Scoring"),
                            React.createElement("canvas", { ref: chartRef })
                        ),
                        React.createElement("div", { className: "glass-card p-6" },
                            React.createElement("h4", {className:"font-bold mb-4 text-blue-900"}, "Placement Feedback"),
                            React.createElement("div", {className: "space-y-4 text-sm"},
                                React.createElement("p", null, React.createElement("b", null, "Aptitude: "), avg > 70 ? "Strong analytical skills." : "Needs more practice in logic."),
                                React.createElement("p", null, React.createElement("b", null, "Technical: "), "Focus on keyword accuracy for better industry visibility."),
                                React.createElement("button", { onClick: () => window.location.reload(), className: "w-full btn-primary py-4 rounded-xl mt-4" }, "NEW SESSION")
                            )
                        )
                    )
                );
            }
        }

        ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(InterviewPortal));
    </script>
</body>
</html>