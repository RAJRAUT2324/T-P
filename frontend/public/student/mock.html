<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Advanced Mock Interview Simulator</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- React & ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
video { transform: scaleX(-1); border-radius:12px; }
.textarea-scroll::-webkit-scrollbar { width:6px; }
.textarea-scroll::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.3); border-radius:3px; }
</style>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script>
const { useState, useEffect, useRef } = React;

const QUESTION_BANK = [
  { id:1, category:"Behavioral", question:"Tell me about a time you faced a difficult challenge at work and how you overcame it.", hint:"Use STAR method: Situation, Task, Action, Result.", keywords:["star","situation","task","action","result","overcame"] },
  { id:2, category:"Technical (React)", question:"Explain the Virtual DOM and how it improves performance.", hint:"Mention diffing, reconciliation, minimal DOM manipulation.", keywords:["virtual dom","diffing","reconciliation","performance","dom"] },
  { id:3, category:"Technical (JavaScript)", question:"What is the difference between 'var', 'let', and 'const'?", hint:"Focus on scope and hoisting", keywords:["var","let","const","scope","hoisting"] },
  { id:4, category:"Situational", question:"You realize a project will miss its deadline. How do you handle this?", hint:"Communicate early, propose new timeline, suggest cutting non-essential features.", keywords:["communicate","stakeholders","timeline","deadline","features"] }
];

function MockInterviewApp() {
  const [started,setStarted]=useState(false);
  const [currentQIndex,setCurrentQIndex]=useState(0);
  const [userAnswer,setUserAnswer]=useState("");
  const [showHint,setShowHint]=useState(false);
  const [timer,setTimer]=useState(0);
  const [isFinished,setIsFinished]=useState(false);
  const [scores,setScores]=useState([]);
  const [recordedChunks,setRecordedChunks]=useState([]);
  const [mediaRecorder,setMediaRecorder]=useState(null);

  const videoRef = useRef(null);
  const chartRef = useRef(null);
  const recognitionRef = useRef(null);

  // Timer
  useEffect(()=>{
    let interval=null;
    if(started && !isFinished){
      interval=setInterval(()=>setTimer(prev=>prev+1),1000);
    }
    return ()=>clearInterval(interval);
  },[started,isFinished]);

  // Webcam + Audio recording
  const startVideoAndRecording = async ()=>{
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      videoRef.current.srcObject = stream;

      const recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => setRecordedChunks(prev=>[...prev,e.data]);
      recorder.start();
      setMediaRecorder(recorder);
    }catch(err){
      alert("Cannot access camera/microphone.");
      console.error(err);
    }
  };

  // Speech-to-text (Chrome only)
  const startSpeechRecognition = ()=>{
    if(!("webkitSpeechRecognition" in window)){
      alert("Speech Recognition not supported. Use Chrome.");
      return;
    }
    const recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = navigator.language || "en-US";

    let finalTranscript = ""; // store final text
    recognition.onresult = event=>{
      let interimTranscript = "";
      for(let i = event.resultIndex; i < event.results.length; i++){
        if(event.results[i].isFinal){
          finalTranscript += event.results[i][0].transcript + " ";
        } else {
          interimTranscript += event.results[i][0].transcript;
        }
      }
      setUserAnswer(finalTranscript + interimTranscript);
    };
    recognition.onerror = e=>console.error(e);
    recognition.start();
    recognitionRef.current = recognition;
  };

  const stopSpeechRecognition = ()=>{
    if(recognitionRef.current){
      recognitionRef.current.stop();
    }
  };

  const handleStart = ()=>{
    setStarted(true);
    startVideoAndRecording();
    startSpeechRecognition();
  };

  const handleNext = ()=>{
    const currentQ = QUESTION_BANK[currentQIndex];
    const answerLower = userAnswer.toLowerCase();
    let score = 0;
    currentQ.keywords.forEach(k=>{ if(answerLower.includes(k.toLowerCase())) score++; });
    const percentage = Math.round((score/currentQ.keywords.length)*100);
    setScores(prev=>[...prev,percentage]);

    setUserAnswer(""); setShowHint(false);

    if(currentQIndex < QUESTION_BANK.length-1){ setCurrentQIndex(prev=>prev+1); }
    else{
      setIsFinished(true);
      if(mediaRecorder) mediaRecorder.stop();
      stopSpeechRecognition();
      setTimeout(renderChart,500);
    }
  };

  const formatTime = seconds=>{
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    return `${m}:${s<10?'0'+s:s}`;
  };

  const renderChart = ()=>{
    const ctx = chartRef.current.getContext("2d");
    new Chart(ctx,{
      type:'bar',
      data:{ labels:QUESTION_BANK.map(q=>q.category), datasets:[{label:"Score (%)", data:scores, backgroundColor:"rgba(59,130,246,0.7)"}] },
      options:{ scales:{ y:{ beginAtZero:true, max:100 } } }
    });
  };

  const downloadRecording = ()=>{
    const blob = new Blob(recordedChunks,{type:"video/webm"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="interview.webm"; a.click();
    URL.revokeObjectURL(url);
  };

  return React.createElement("div",{className:"min-h-screen p-8 flex flex-col items-center"},
    React.createElement("div",{className:"w-full max-w-4xl mb-8 flex justify-between items-center"},
      React.createElement("h1",{className:"text-3xl font-bold text-gray-800"},"Advanced Mock Interview Simulator"),
      started && !isFinished && React.createElement("div",{className:"text-xl font-mono bg-white px-4 py-2 rounded shadow text-red-600"},"â± "+formatTime(timer))
    ),
    React.createElement("div",{className:"w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 gap-8"},
      React.createElement("div",{className:"bg-black rounded-2xl overflow-hidden shadow-xl h-96 relative flex items-center justify-center"},
        started?React.createElement("video",{ref:videoRef,autoPlay:true,muted:true,className:"w-full h-full object-cover"}):
        React.createElement("div",{className:"text-center p-6"}, React.createElement("div",{className:"text-6xl mb-4"},"ðŸ“¹"), React.createElement("p",{className:"text-gray-400"},"Camera preview will appear here")),
        started && !isFinished && React.createElement("div",{className:"absolute top-4 left-4 bg-blue-600 text-white px-3 py-1 rounded-full text-sm"},"Question "+(currentQIndex+1)+"/"+QUESTION_BANK.length)
      ),
      React.createElement("div",{className:"flex flex-col justify-between h-96"},
        !started ? React.createElement("div",{className:"bg-white p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center text-center"},
          React.createElement("h2",{className:"text-2xl font-bold mb-4"},"Ready to practice?"),
          React.createElement("p",{className:"text-gray-600 mb-8"},"This simulator will test your technical and behavioral skills. Turn on your camera & mic to check body language."),
          React.createElement("button",{onClick:handleStart,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full"},"Start Interview")
        ):
        isFinished?React.createElement("div",{className:"bg-white p-8 rounded-2xl shadow-lg h-full flex flex-col justify-center items-center text-center overflow-auto"},
          React.createElement("h2",{className:"text-2xl font-bold text-green-600 mb-4"},"Interview Complete!"),
          React.createElement("p",{className:"text-gray-600 mb-2"},"Total time: "+formatTime(timer)),
          React.createElement("p",{className:"text-gray-600 mb-4"},"Scores per question: "+scores.join("% | ")+"%"),
          React.createElement("canvas",{ref:chartRef,className:"mb-4 w-full h-40"}),
          React.createElement("button",{onClick:downloadRecording,className:"bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-full mb-2"},"Download Recording"),
          React.createElement("button",{onClick:()=>window.location.reload(),className:"border-2 border-blue-600 text-blue-600 font-bold py-2 px-6 rounded-full hover:bg-blue-50"},"Restart Session")
        ):
        React.createElement("div",{className:"bg-white p-6 rounded-2xl shadow-lg h-full flex flex-col"},
          React.createElement("span",{className:"text-sm font-bold text-blue-500 uppercase mb-2"},QUESTION_BANK[currentQIndex].category),
          React.createElement("h3",{className:"text-xl font-semibold text-gray-800 mb-4"},QUESTION_BANK[currentQIndex].question),
          React.createElement("textarea",{className:"w-full flex-grow bg-gray-50 border border-gray-200 rounded-lg p-4 mb-2 resize-none textarea-scroll",placeholder:"Type or speak your answer here...", value:userAnswer,onChange:e=>setUserAnswer(e.target.value)}),
          showHint && React.createElement("div",{className:"mb-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm"},React.createElement("strong",null,"Expected Answer Key: "),QUESTION_BANK[currentQIndex].hint),
          React.createElement("div",{className:"flex gap-2 mt-auto"},
            React.createElement("button",{onClick:()=>setShowHint(!showHint),className:"flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50"}, showHint?"Hide Reference":"Show Reference"),
            React.createElement("button",{onClick:handleNext,className:"flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700"},currentQIndex===QUESTION_BANK.length-1?"Finish":"Next Question")
          )
        )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(MockInterviewApp));
</script>
</body>
</html>
