<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile | T&P Management AI</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* [YOUR EXISTING CSS - PRESERVED] */
        :root { --primary-dark: #0a3d91; --primary-royal: #0a66c2; --bg-white: #ffffff; --accent-orange: #f2ad58; --bg-light-gray: #f4f6fa; --text-dark: #333333; --text-muted: #666666; --social-linkedin: #0a66c2; --social-instagram: #e1306c; --social-twitter: #1da1f2; --social-youtube: #ff0000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-light-gray); color: var(--text-dark); display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background-color: var(--primary-dark); color: white; display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; }
        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent-orange); }
        .nav-links a { display: flex; align-items: center; gap: 12px; color: rgba(255,255,255,0.8); text-decoration: none; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; transition: 0.3s; }
        .nav-links a:hover, .nav-links a.active { background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--accent-orange); }
        .main-content { margin-left: 260px; flex: 1; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--primary-dark); }
        .btn-primary { background-color: var(--primary-royal); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover { background-color: #084e96; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; }
        .card { background: var(--bg-white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid var(--primary-royal); }
        .profile-header { text-align: center; margin-bottom: 20px; }
        .profile-img { width: 120px; height: 120px; background-color: #ddd; border-radius: 50%; margin: 0 auto 15px; object-fit: cover; border: 3px solid var(--primary-royal); }
        .profile-name { font-size: 1.4rem; font-weight: bold; color: var(--primary-dark); }
        .profile-role { color: var(--accent-orange); font-weight: 600; margin-bottom: 10px; }
        .info-list { list-style: none; text-align: left; margin-top: 20px; }
        .info-list li { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; display: flex; justify-content: space-between; }
        .info-list span { color: var(--text-muted); }
        .social-links { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .social-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-light-gray); display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--text-dark); transition: 0.3s; font-size: 1.2rem; }
        .social-btn.linkedin:hover { background: var(--social-linkedin); color: white; }
        .social-btn.instagram:hover { background: var(--social-instagram); color: white; }
        .social-btn.twitter:hover { background: var(--social-twitter); color: white; }
        .social-btn.youtube:hover { background: var(--social-youtube); color: white; }
        .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: var(--bg-white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .chart-title { font-size: 1.1rem; color: var(--primary-dark); margin-bottom: 15px; border-bottom: 2px solid var(--bg-light-gray); padding-bottom: 10px; }
        .ai-badge { background: linear-gradient(45deg, var(--primary-dark), var(--primary-royal)); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; float: right; }
        @media (max-width: 900px) { .dashboard-grid, .charts-container { grid-template-columns: 1fr; } .sidebar { width: 70px; padding: 10px; } .nav-links span, .logo span { display: none; } .main-content { margin-left: 70px; } }

        /* --- MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 2% auto; padding: 20px; border-radius: 12px; width: 60%; max-width: 700px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-dark); font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .form-row-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .section-head { color: var(--primary-dark); margin: 15px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .save-btn { width: 100%; background: var(--primary-royal); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; margin-top: 20px; }
        .save-btn:hover { background: var(--primary-dark); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <i class="fa-solid fa-graduation-cap"></i>
            <span>T&P AI</span>
        </div>
        <nav class="nav-links">
            <a href="#" class="active"><i class="fa-solid fa-user"></i> <span>My Profile</span></a>
            <a href="#"><i class="fa-solid fa-chart-line"></i> <span>Performance</span></a>
            <a href="#"><i class="fa-solid fa-briefcase"></i> <span>Placements</span></a>
            <a href="#"><i class="fa-solid fa-file-invoice"></i> <span>AI Resume</span></a>
            <a href="#"><i class="fa-solid fa-bell"></i> <span>Notices</span></a>
            <a href="dashboard.html"><i class="fa-solid fa-arrow-left"></i> <span>Back to Dashboard</span></a>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <h1>Student Dashboard</h1>
                <p style="color: var(--text-muted);">Welcome back, check your placement readiness.</p>
            </div>
            <button class="btn-primary" onclick="openModal()">Edit Profile</button>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="profile-header">
                    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Student" class="profile-img">
                    <h2 class="profile-name" id="p_name">Loading...</h2>
                    <p class="profile-role">Computer Science Engineering</p>
                    <div style="margin-top: 10px;">
                        <span style="background: var(--bg-light-gray); padding: 5px 10px; border-radius: 4px; font-size: 0.9rem;">
                            <i class="fa-solid fa-location-dot" style="color:var(--primary-royal)"></i> <span id="p_location">...</span>
                        </span>
                    </div>
                </div>
                <ul class="info-list">
                    <li><span>Roll No:</span> <strong id="p_roll">...</strong></li>
                    <li><span>Email:</span> <strong id="p_email">...</strong></li>
                    <li><span>Phone:</span> <strong id="p_phone">...</strong></li>
                    <li><span>CGPA:</span> <strong id="p_cgpa">...</strong></li>
                    <li><span>Batch:</span> <strong id="p_batch">...</strong></li>
                </ul>
            </div>

            <div class="charts-section">
                <div class="chart-box" style="margin-bottom: 25px;">
                    <h3 class="chart-title">Technical Skill Analysis</h3>
                    <div style="height: 250px;">
                        <canvas id="skillsChart"></canvas>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-box">
                        <h3 class="chart-title">Placement Probability</h3>
                        <div style="height: 200px; display: flex; justify-content: center;">
                            <canvas id="doughnutChart"></canvas>
                        </div>
                        <p style="text-align: center; margin-top: 10px; color: var(--text-muted); font-size: 0.9rem;">Based on current CGPA & Skills</p>
                    </div>
                    <div class="chart-box">
                        <h3 class="chart-title">Mock Test Performance</h3>
                        <div style="height: 200px;">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile & Stats</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                
                <h4 class="section-head">Personal Details</h4>
                <div class="form-row">
                    <div class="form-group"><label>Name</label><input type="text" id="edit_name"></div>
                    <div class="form-group"><label>Phone</label><input type="text" id="edit_phone"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Roll No</label><input type="text" id="edit_roll"></div>
                    <div class="form-group"><label>Location</label><input type="text" id="edit_location"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>CGPA</label><input type="number" step="0.1" id="edit_cgpa"></div>
                    <div class="form-group"><label>Batch</label><input type="text" id="edit_batch"></div>
                </div>

                <h4 class="section-head">Graph 1: Technical Skills (0-100)</h4>
                <div class="form-row-3">
                    <div class="form-group"><label>Java</label><input type="number" id="skill_java" max="100"></div>
                    <div class="form-group"><label>React</label><input type="number" id="skill_react" max="100"></div>
                    <div class="form-group"><label>Python</label><input type="number" id="skill_python" max="100"></div>
                    <div class="form-group"><label>DSA</label><input type="number" id="skill_dsa" max="100"></div>
                    <div class="form-group"><label>SQL</label><input type="number" id="skill_sql" max="100"></div>
                    <div class="form-group"><label>Comm.</label><input type="number" id="skill_comm" max="100"></div>
                </div>

                <h4 class="section-head">Graph 2: Placement Readiness</h4>
                <div class="form-group">
                    <label>Placement Probability (%)</label>
                    <input type="number" id="edit_readiness" max="100" placeholder="e.g. 85">
                </div>

                <h4 class="section-head">Graph 3: Mock Test Scores</h4>
                <div class="form-row-5">
                    <div class="form-group"><label>Test 1</label><input type="number" id="score_1" max="100"></div>
                    <div class="form-group"><label>Test 2</label><input type="number" id="score_2" max="100"></div>
                    <div class="form-group"><label>Test 3</label><input type="number" id="score_3" max="100"></div>
                    <div class="form-group"><label>Test 4</label><input type="number" id="score_4" max="100"></div>
                    <div class="form-group"><label>Test 5</label><input type="number" id="score_5" max="100"></div>
                </div>

                <button type="button" class="save-btn" onclick="updateProfile()">Save & Update Charts</button>
            </form>
        </div>
    </div>

    <script>
        let skillsChartInstance = null;
        let doughnutChartInstance = null;
        let lineChartInstance = null;

        async function loadProfileData() {
            const token = localStorage.getItem('auth-token');
            if (!token) { window.location.href = "../login.html"; return; }

            try {
                const response = await fetch('http://localhost:5000/api/auth/getuser', {
                    method: 'GET',
                    headers: { 'auth-token': token }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // 1. Update Profile Text
                    document.getElementById('p_name').innerText = user.name;
                    document.getElementById('p_email').innerText = user.email;
                    document.getElementById('p_roll').innerText = user.rollNo || "Not Set";
                    document.getElementById('p_phone').innerText = user.phone || "Not Set";
                    document.getElementById('p_location').innerText = user.location || "Amravati, MH";
                    document.getElementById('p_cgpa').innerText = (user.cgpa || 0) + " / 10.0";
                    document.getElementById('p_batch').innerText = user.batch || "2025";

                    // 2. Pre-fill EDIT Form
                    document.getElementById('edit_name').value = user.name;
                    document.getElementById('edit_phone').value = user.phone;
                    document.getElementById('edit_roll').value = user.rollNo;
                    document.getElementById('edit_location').value = user.location;
                    document.getElementById('edit_cgpa').value = user.cgpa;
                    document.getElementById('edit_batch').value = user.batch;
                    
                    const s = user.skills || {};
                    document.getElementById('skill_java').value = s.java || 0;
                    document.getElementById('skill_react').value = s.react || 0;
                    document.getElementById('skill_python').value = s.python || 0;
                    document.getElementById('skill_dsa').value = s.dsa || 0;
                    document.getElementById('skill_sql').value = s.sql || 0;
                    document.getElementById('skill_comm').value = s.comm || 0;

                    // New Fields
                    document.getElementById('edit_readiness').value = user.readiness || 0;
                    const m = user.mockScores || [0,0,0,0,0];
                    document.getElementById('score_1').value = m[0] || 0;
                    document.getElementById('score_2').value = m[1] || 0;
                    document.getElementById('score_3').value = m[2] || 0;
                    document.getElementById('score_4').value = m[3] || 0;
                    document.getElementById('score_5').value = m[4] || 0;

                    renderCharts(user);
                }
            } catch (error) { console.error("Error:", error); }
        }

        async function updateProfile() {
            const token = localStorage.getItem('auth-token');
            const saveBtn = document.querySelector('.save-btn');
            saveBtn.innerText = "Saving...";

            const updatedData = {
                name: document.getElementById('edit_name').value,
                phone: document.getElementById('edit_phone').value,
                rollNo: document.getElementById('edit_roll').value,
                location: document.getElementById('edit_location').value,
                cgpa: document.getElementById('edit_cgpa').value,
                batch: document.getElementById('edit_batch').value,
                
                // SKILLS
                skills: {
                    java: document.getElementById('skill_java').value,
                    react: document.getElementById('skill_react').value,
                    python: document.getElementById('skill_python').value,
                    dsa: document.getElementById('skill_dsa').value,
                    sql: document.getElementById('skill_sql').value,
                    comm: document.getElementById('skill_comm').value
                },
                
                // PLACEMENT PROBABILITY
                readiness: document.getElementById('edit_readiness').value,

                // MOCK SCORES
                mockScores: [
                    document.getElementById('score_1').value,
                    document.getElementById('score_2').value,
                    document.getElementById('score_3').value,
                    document.getElementById('score_4').value,
                    document.getElementById('score_5').value
                ]
            };

            try {
                const response = await fetch('http://localhost:5000/api/auth/updateuser', {
                    method: 'PUT',
                    headers: { 'auth-token': token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    alert("Updated Successfully!");
                    closeModal();
                    loadProfileData(); 
                } else {
                    alert("Failed to update");
                }
            } catch (error) { console.error(error); alert("Server Error"); }
            finally { saveBtn.innerText = "Save & Update Charts"; }
        }

        function renderCharts(user) {
            const skills = user.skills || {};
            const mockScores = user.mockScores || [0,0,0,0,0];
            const ready = user.readiness || 0; 

            if (skillsChartInstance) skillsChartInstance.destroy();
            if (doughnutChartInstance) doughnutChartInstance.destroy();
            if (lineChartInstance) lineChartInstance.destroy();

            // 1. Bar Chart
            skillsChartInstance = new Chart(document.getElementById('skillsChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Java', 'React JS', 'Python', 'DSA', 'SQL', 'Comm.'],
                    datasets: [{
                        label: 'Proficiency (%)',
                        data: [skills.java, skills.react, skills.python, skills.dsa, skills.sql, skills.comm],
                        backgroundColor: '#0a66c2', borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // 2. Doughnut (Dynamic Readiness)
            doughnutChartInstance = new Chart(document.getElementById('doughnutChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Ready', 'Improvement'],
                    datasets: [{
                        data: [ready, 100 - ready],
                        backgroundColor: ['#0a3d91', '#f4f6fa'], borderWidth: 0
                    }]
                },
                options: { cutout: '70%', responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // 3. Line Chart (Dynamic Mock Scores)
            lineChartInstance = new Chart(document.getElementById('lineChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Test 1', 'Test 2', 'Test 3', 'Test 4', 'Test 5'],
                    datasets: [{
                        label: 'Score', data: mockScores,
                        borderColor: '#f2ad58', backgroundColor: 'rgba(242, 173, 88, 0.2)', fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function openModal() { document.getElementById('editModal').style.display = "block"; }
        function closeModal() { document.getElementById('editModal').style.display = "none"; }
        window.onclick = function(event) { if (event.target == document.getElementById('editModal')) closeModal(); }

        window.onload = loadProfileData;
    </script>
</body>
</html>